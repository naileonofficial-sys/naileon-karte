<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ«ãƒ†å…¥åŠ› - ãƒã‚¤ãƒ¬ã‚ªãƒ³</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: linear-gradient(135deg, #ffeef8 0%, #fff5f7 100%);
      min-height: 100vh;
      padding: 20px 20px 100px 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    /* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }
    .step-item {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e0e0e0;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #999;
      transition: all 0.3s;
    }
    .step-item.active .step-circle {
      background: #ff6b9d;
      border-color: #ff6b9d;
      color: white;
    }
    .step-item.completed .step-circle {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }
    .step-label {
      font-size: 12px;
      color: #999;
      font-weight: 500;
    }
    .step-item.active .step-label {
      color: #ff6b9d;
      font-weight: 600;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 10px;
      margin-bottom: 30px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #c44569);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255,107,157,0.5);
    }
    .progress-text {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 8px;
      font-weight: 500;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      margin-bottom: 20px;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .question-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 24px;
      color: #333;
      line-height: 1.5;
    }
    
    .option-btn {
      display: block;
      width: 100%;
      padding: 18px 20px;
      margin-bottom: 12px;
      background: #f8f9fa;
      border: 2px solid #f8f9fa;
      border-radius: 14px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      font-weight: 500;
      color: #333;
    }
    .option-btn:hover {
      background: #fff;
      border-color: #ffb3d1;
      transform: translateX(4px);
    }
    .option-btn.selected {
      background: #fff;
      border-color: #ff6b9d;
      color: #ff6b9d;
      font-weight: 600;
    }
    
    .input-field {
      width: 100%;
      padding: 18px;
      border: 2px solid #e9ecef;
      border-radius: 14px;
      font-size: 16px;
      transition: all 0.3s;
      font-family: inherit;
      margin-bottom: 12px;
    }
    .input-field:focus {
      outline: none;
      border-color: #ff6b9d;
      box-shadow: 0 0 0 4px rgba(255,107,157,0.1);
    }
    
    .checkbox-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .checkbox-container:hover {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
    }
    .checkbox-label {
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      flex: 1;
    }
    
    /* å‚è€ƒæ–™é‡‘è¡¨ç¤º */
    .price-display {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      margin: 30px 0;
      animation: fadeIn 0.6s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .price-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 12px;
    }
    .price-amount {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .price-note {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* ä¸‹éƒ¨å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ */
    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px 20px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      z-index: 100;
    }
    
    .nav-buttons {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
    }
    .btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }
    .btn-back {
      background: #f8f9fa;
      color: #666;
    }
    .btn-back:hover {
      background: #e9ecef;
    }
    .btn-next {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
      box-shadow: 0 4px 12px rgba(255,107,157,0.3);
    }
    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,107,157,0.4);
    }
    .btn-next:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .completion-screen {
      text-align: center;
      padding: 60px 20px;
    }
    .completion-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: bounce 1s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .completion-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
    }
    .completion-text {
      color: #666;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    .completion-highlight {
      color: #ff6b9d;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="step-indicator" id="stepIndicator">
      <div class="step-item active" data-step="1">
        <div class="step-circle">1</div>
        <div class="step-label">åŸºæœ¬æƒ…å ±</div>
      </div>
      <div class="step-item" data-step="2">
        <div class="step-circle">2</div>
        <div class="step-label">å¸Œæœ›æ—¥æ™‚</div>
      </div>
      <div class="step-item" data-step="3">
        <div class="step-circle">3</div>
        <div class="step-label">è©³ç´°æƒ…å ±</div>
      </div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>
    <div class="progress-text" id="progressText"></div>

    <div class="card" id="questionCard">
      <div class="question-title" id="questionTitle"></div>
      <div id="questionContent"></div>
    </div>
  </div>
  
  <div class="fixed-footer" id="footer">
    <div class="nav-buttons">
      <button class="btn btn-back" id="backBtn" onclick="goBack()">â† æˆ»ã‚‹</button>
      <button class="btn btn-next" id="nextBtn" onclick="goNext()">æ¬¡ã¸ â†’</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId') || 'test_user';
    let currentStepNumber = parseInt(urlParams.get('step')) || 1;
    
    let karteData = {
      userId: userId,
      timestamp: new Date().toISOString(),
      step: currentStepNumber
    };
    
    // æ–™é‡‘ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
    const priceData = [
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚±ã‚¢', detail: 'ã‚»ãƒƒãƒˆï¼ˆç”˜çš®å‡¦ç†/ç£¨ã/å½¢æˆï¼‰', off: 'ãªã—', price: 8000 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚±ã‚¢', detail: 'ã‚»ãƒƒãƒˆï¼ˆç”˜çš®å‡¦ç†/ç£¨ã/å½¢æˆï¼‰', off: 'ã‚ã‚Š', price: 9250 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚±ã‚¢', detail: 'ã‚ªãƒ•ã®ã¿', off: 'ã‚ã‚Š', price: 8000 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ãƒ¯ãƒ³ã‚«ãƒ©ãƒ¼', off: 'ãªã—', price: 11125 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ãƒ¯ãƒ³ã‚«ãƒ©ãƒ¼', off: 'ã‚ã‚Š', price: 11750 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³', off: 'ãªã—', price: 12375 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³', off: 'ã‚ã‚Š', price: 13000 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚¢ãƒ¼ãƒˆ', off: 'ãªã—', price: 15500 },
      { target: 'ãƒãƒ³ãƒ‰', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚¢ãƒ¼ãƒˆ', off: 'ã‚ã‚Š', price: 16750 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ãƒ¯ãƒ³ã‚«ãƒ©ãƒ¼', off: 'ãªã—', price: 11750 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ãƒ¯ãƒ³ã‚«ãƒ©ãƒ¼', off: 'ã‚ã‚Š', price: 13000 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³', off: 'ãªã—', price: 13000 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³', off: 'ã‚ã‚Š', price: 14250 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚¢ãƒ¼ãƒˆ', off: 'ãªã—', price: 16750 },
      { target: 'ãƒ•ãƒƒãƒˆ', category: 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«', detail: 'ã‚¢ãƒ¼ãƒˆ', off: 'ã‚ã‚Š', price: 18000 }
    ];
    
    // è³ªå•å®šç¾©ï¼ˆã‚¹ãƒ†ãƒƒãƒ—åˆ¥ï¼‰
    const questionsByStep = {
      1: [ // ãƒ©ã‚¤ãƒˆã‚«ãƒ«ãƒ†
        {
          id: 'prefecture',
          title: 'ã©ã¡ã‚‰ã®éƒ½é“åºœçœŒã§ã™ã‹?',
          type: 'select',
          options: [
            'åŒ—æµ·é“', 'é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ',
            'èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ', 'åŸ¼ç‰çœŒ', 'åƒè‘‰çœŒ', 'æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ',
            'æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ',
            'å²é˜œçœŒ', 'é™å²¡çœŒ', 'æ„›çŸ¥çœŒ', 'ä¸‰é‡çœŒ',
            'æ»‹è³€çœŒ', 'äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'å…µåº«çœŒ', 'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ',
            'é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ',
            'å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ',
            'ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ', 'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ', 'æ²–ç¸„çœŒ'
          ].map(p => ({ value: p, label: p }))
        },
        {
          id: 'city',
          title: 'å¸‚åŒºç”ºæ‘ã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'text',
          placeholder: 'ä¾‹: æ¸‹è°·åŒº'
        },
        {
          id: 'menuTarget',
          title: 'ãƒãƒ³ãƒ‰ã¨ãƒ•ãƒƒãƒˆã€ã©ã¡ã‚‰ã§ã™ã‹?',
          type: 'select',
          options: [
            { value: 'ãƒãƒ³ãƒ‰', label: 'ğŸ’… ãƒãƒ³ãƒ‰' },
            { value: 'ãƒ•ãƒƒãƒˆ', label: 'ğŸ¦¶ ãƒ•ãƒƒãƒˆ' }
          ]
        },
        {
          id: 'menuCategory',
          title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„',
          type: 'select',
          options: [],
          dynamic: true
        },
        {
          id: 'menuDetail',
          title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è©³ç´°ã‚’é¸æŠã—ã¦ãã ã•ã„',
          type: 'select',
          options: [],
          dynamic: true
        },
        {
          id: 'hasOff',
          title: 'ã‚ªãƒ•ï¼ˆã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«ã‚’è½ã¨ã™ï¼‰ã¯å¿…è¦ã§ã™ã‹?',
          type: 'select',
          options: [
            { value: 'ãªã—', label: 'âŒ å¿…è¦ãªã—' },
            { value: 'ã‚ã‚Š', label: 'âœ… å¿…è¦ã‚ã‚Š' }
          ],
          condition: (data) => data.menuCategory === 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«'
        },
        {
          id: 'scene',
          title: 'ã©ã“ã§æ–½è¡“ã‚’å—ã‘ã¾ã™ã‹?',
          type: 'select',
          options: [
            { value: 'home', label: 'ğŸ  è‡ªå®…ãƒ»ãƒãƒ³ã‚·ãƒ§ãƒ³' },
            { value: 'hospital', label: 'ğŸ¥ ç—…é™¢ãƒ»ã‚¯ãƒªãƒ‹ãƒƒã‚¯' },
            { value: 'postnatal', label: 'ğŸ‘¶ ç”£å¾Œã‚±ã‚¢æ–½è¨­' },
            { value: 'care', label: 'ğŸ¢ ä»‹è­·ãƒ»ç¦ç¥‰æ–½è¨­' }
          ]
        },
        {
          id: 'hospitalName',
          title: 'æ–½è¨­åã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'text',
          placeholder: 'ä¾‹: â—‹â—‹ç·åˆç—…é™¢',
          condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
        },
        {
          id: 'permission',
          title: 'æ–½è¨­ã¸ã®è¨±å¯ã¯å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã‹?',
          type: 'select',
          options: [
            { value: 'obtained', label: 'âœ… å–å¾—æ¸ˆã¿' },
            { value: 'pending', label: 'â³ ç¢ºèªä¸­' },
            { value: 'not_yet', label: 'âŒ ã¾ã ã§ã™' }
          ],
          condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
        }
      ],
      2: [ // ãƒŸãƒ‰ãƒ«ã‚«ãƒ«ãƒ†
        {
          id: 'preferredDate1',
          title: 'ç¬¬1å¸Œæœ›æ—¥æ™‚ã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'datetime-local'
        },
        {
          id: 'preferredDate2',
          title: 'ç¬¬2å¸Œæœ›æ—¥æ™‚ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰',
          type: 'datetime-local',
          required: false
        },
        {
          id: 'preferredDate3',
          title: 'ç¬¬3å¸Œæœ›æ—¥æ™‚ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰',
          type: 'datetime-local',
          required: false
        }
      ],
      3: [ // ãƒ•ãƒ«ã‚«ãƒ«ãƒ†
        {
          id: 'fullName',
          title: 'æœ¬åï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'text',
          placeholder: 'ä¾‹: å±±ç”°èŠ±å­'
        },
        {
          id: 'age',
          title: 'å¹´é½¢ã¾ãŸã¯å¹´ä»£ã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'select',
          options: [
            { value: '10ä»£', label: '10ä»£' },
            { value: '20ä»£', label: '20ä»£' },
            { value: '30ä»£', label: '30ä»£' },
            { value: '40ä»£', label: '40ä»£' },
            { value: '50ä»£', label: '50ä»£' },
            { value: '60ä»£ä»¥ä¸Š', label: '60ä»£ä»¥ä¸Š' }
          ]
        },
        {
          id: 'emergencyContact',
          title: 'ç·Šæ€¥é€£çµ¡å…ˆï¼ˆé›»è©±ç•ªå·ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰',
          type: 'text',
          placeholder: 'ä¾‹: 09012345678 ã¾ãŸã¯ example@email.com'
        },
        {
          id: 'cancelPolicy',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã„ãŸã ã‘ã¾ã™ã‹?',
          type: 'checkbox',
          label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ï¼ˆå‰æ—¥ã‚­ãƒ£ãƒ³ã‚»ãƒ«:50%ã€å½“æ—¥ã‚­ãƒ£ãƒ³ã‚»ãƒ«:100%ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãŒç™ºç”Ÿã—ã¾ã™ï¼‰'
        },
        {
          id: 'roomNumber',
          title: 'ç—…å®¤ç•ªå·ã‚’æ•™ãˆã¦ãã ã•ã„',
          type: 'text',
          placeholder: 'ä¾‹: 3éš 305å·å®¤',
          condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
        },
        {
          id: 'visitingInstructions',
          title: 'è¨ªå•æ™‚ã®æ³¨æ„äº‹é …ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„',
          type: 'textarea',
          placeholder: 'ä¾‹: é¢ä¼šæ™‚é–“ã¯14æ™‚ä»¥é™ã€ãƒŠãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å£°ã‚’ã‹ã‘ã¦ãã ã•ã„',
          required: false,
          condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
        }
      ]
    };
    
    let currentQuestionIndex = 0;
    let visibleQuestions = [];
    
    // åˆæœŸåŒ–
    init();
    
    function init() {
      updateStepIndicator();
      updateVisibleQuestions();
      showQuestion();
    }
    
    function updateStepIndicator() {
      const steps = document.querySelectorAll('.step-item');
      steps.forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        if (stepNum < currentStepNumber) {
          step.classList.add('completed');
        } else if (stepNum === currentStepNumber) {
          step.classList.add('active');
        }
      });
    }
    
    function updateVisibleQuestions() {
      const allQuestions = questionsByStep[currentStepNumber] || [];
      visibleQuestions = allQuestions.filter(q => {
        if (q.condition) return q.condition(karteData);
        return true;
      });
      
      // å‹•çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
      visibleQuestions.forEach(q => {
        if (q.dynamic) {
          if (q.id === 'menuCategory') {
            const categories = [...new Set(priceData
              .filter(p => p.target === karteData.menuTarget)
              .map(p => p.category))];
            q.options = categories.map(c => ({ value: c, label: c }));
          } else if (q.id === 'menuDetail') {
            const details = [...new Set(priceData
              .filter(p => p.target === karteData.menuTarget && p.category === karteData.menuCategory)
              .map(p => p.detail))];
            q.options = details.map(d => ({ value: d, label: d }));
          }
        }
      });
    }
    
    function showQuestion() {
      updateVisibleQuestions();
      
      if (currentQuestionIndex >= visibleQuestions.length) {
        handleStepCompletion();
        return;
      }
      
      const question = visibleQuestions[currentQuestionIndex];
      const progress = ((currentQuestionIndex + 1) / visibleQuestions.length) * 100;
      
      document.getElementById('progress').style.width = progress + '%';
      document.getElementById('progressText').textContent = 
        `ã‚¹ãƒ†ãƒƒãƒ—${currentStepNumber}: è³ªå• ${currentQuestionIndex + 1} / ${visibleQuestions.length}`;
      document.getElementById('questionTitle').textContent = question.title;
      document.getElementById('backBtn').style.display = currentQuestionIndex === 0 && currentStepNumber === 1 ? 'none' : 'block';
      
      const content = document.getElementById('questionContent');
      content.innerHTML = '';
      
      if (question.type === 'select') {
        question.options.forEach(option => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = option.label;
          btn.onclick = () => selectOption(question.id, option.value);
          
          if (karteData[question.id] === option.value) {
            btn.classList.add('selected');
          }
          
          content.appendChild(btn);
        });
      } else if (question.type === 'checkbox') {
        const container = document.createElement('div');
        container.className = 'checkbox-container';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = question.id;
        checkbox.checked = karteData[question.id] === true;
        checkbox.onchange = (e) => {
          karteData[question.id] = e.target.checked;
          updateNextButton();
        };
        
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        label.htmlFor = question.id;
        label.textContent = question.label;
        label.onclick = () => {
          checkbox.checked = !checkbox.checked;
          karteData[question.id] = checkbox.checked;
          updateNextButton();
        };
        
        container.appendChild(checkbox);
        container.appendChild(label);
        content.appendChild(container);
      } else if (question.type === 'textarea') {
        const textarea = document.createElement('textarea');
        textarea.className = 'input-field';
        textarea.placeholder = question.placeholder || '';
        textarea.value = karteData[question.id] || '';
        textarea.rows = 4;
        textarea.oninput = (e) => {
          karteData[question.id] = e.target.value;
          updateNextButton();
        };
        content.appendChild(textarea);
      } else {
        const input = document.createElement('input');
        input.className = 'input-field';
        input.type = question.type;
        input.placeholder = question.placeholder || '';
        input.value = karteData[question.id] || '';
        input.oninput = (e) => {
          karteData[question.id] = e.target.value;
          updateNextButton();
        };
        content.appendChild(input);
      }
      
      updateNextButton();
    }
    
    function selectOption(key, value) {
      karteData[key] = value;
      showQuestion();
      updateNextButton();
    }
    
    function updateNextButton() {
      const question = visibleQuestions[currentQuestionIndex];
      const hasAnswer = question.required === false || 
        (karteData[question.id] !== undefined && 
         karteData[question.id] !== '' && 
         karteData[question.id] !== false);
      document.getElementById('nextBtn').disabled = !hasAnswer;
    }
    
    function goBack() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion();
      } else if (currentStepNumber > 1) {
        // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‹
        currentStepNumber--;
        currentQuestionIndex = questionsByStep[currentStepNumber].length - 1;
        updateStepIndicator();
        updateVisibleQuestions();
        showQuestion();
      }
    }
    
    function goNext() {
      currentQuestionIndex++;
      showQuestion();
    }
    
    function handleStepCompletion() {
      if (currentStepNumber === 1) {
        // ã‚¹ãƒ†ãƒƒãƒ—1å®Œäº† â†’ å‚è€ƒæ–™é‡‘è¡¨ç¤º
        showPriceEstimate();
      } else if (currentStepNumber === 2) {
        // ã‚¹ãƒ†ãƒƒãƒ—2å®Œäº† â†’ ã‚¹ãƒ†ãƒƒãƒ—3ã¸
        moveToNextStep();
      } else if (currentStepNumber === 3) {
        // ã‚¹ãƒ†ãƒƒãƒ—3å®Œäº† â†’ é€ä¿¡
        submitKarte();
      }
    }
    
    function showPriceEstimate() {
      const price = calculatePrice();
      
      const cardElement = document.getElementById('questionCard');
      cardElement.innerHTML = `
        <div style="text-align: center;">
          <h2 style="font-size: 24px; margin-bottom: 30px; color: #333;">âœ¨ å‚è€ƒæ–™é‡‘ã®ã”æ¡ˆå†…</h2>
          
          <div class="price-display">
            <div class="price-label">å‚è€ƒæ–™é‡‘ï¼ˆç¨è¾¼ï¼‰</div>
            <div class="price-amount">Â¥${price.toLocaleString()}</div>
            <div class="price-note">â€»ãƒã‚¤ãƒªã‚¹ãƒˆã«ã‚ˆã‚Šå‰å¾Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</div>
          </div>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 14px; margin-top: 20px; text-align: left;">
            <div style="font-size: 14px; color: #666; margin-bottom: 12px;">
              <strong>é¸æŠå†…å®¹:</strong><br>
              ${karteData.menuTarget} / ${karteData.menuCategory} / ${karteData.menuDetail}
              ${karteData.hasOff ? ' / ã‚ªãƒ•ã‚ã‚Š' : ''}
            </div>
            <div style="font-size: 14px; color: #666;">
              <strong>å ´æ‰€:</strong> ${karteData.prefecture} ${karteData.city}
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 24px; border-radius: 14px; margin-top: 30px; border: 2px solid #ffb74d;">
            <div style="font-size: 18px; font-weight: 700; color: #e65100; margin-bottom: 12px;">
              ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            </div>
            <p style="color: #333; font-size: 15px; line-height: 1.8; margin: 0;">
              ã“ã®æ–™é‡‘ã§å•é¡Œãªã‘ã‚Œã°ã€<br>
              <strong style="color: #ff6b9d;">å¸Œæœ›æ—¥æ™‚</strong>ã‚’ãŠèã‹ã›ãã ã•ã„
            </p>
          </div>
        </div>
      `;
      
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.textContent = 'å¸Œæœ›æ—¥æ™‚ã‚’å…¥åŠ›ã™ã‚‹ â†’';
      nextBtn.disabled = false;
      nextBtn.onclick = moveToNextStep;
      
      document.getElementById('backBtn').onclick = () => {
        currentQuestionIndex = visibleQuestions.length - 1;
        document.getElementById('nextBtn').textContent = 'æ¬¡ã¸ â†’';
        document.getElementById('nextBtn').onclick = goNext;
        document.getElementById('backBtn').onclick = goBack;
        showQuestion();
      };
    }
    
    function calculatePrice() {
      const match = priceData.find(p => 
        p.target === karteData.menuTarget &&
        p.category === karteData.menuCategory &&
        p.detail === karteData.menuDetail &&
        (karteData.menuCategory !== 'ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«' || p.off === karteData.hasOff)
      );
      return match ? match.price : 0;
    }
    
    function moveToNextStep() {
      // ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚’å¢—ã‚„ã™
      currentStepNumber++;
      currentQuestionIndex = 0;
      karteData.step = currentStepNumber;
      
      // UIã‚’æ›´æ–°
      updateStepIndicator();
      updateVisibleQuestions();
      
      // ã‚«ãƒ¼ãƒ‰ã®æ§‹é€ ã‚’å¾©å…ƒ
      const cardElement = document.getElementById('questionCard');
      cardElement.innerHTML = `
        <div class="question-title" id="questionTitle"></div>
        <div id="questionContent"></div>
      `;
      
      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆéåŒæœŸï¼‰
      if (currentStepNumber === 2) {
        saveKarteData('light');
      } else if (currentStepNumber === 3) {
        saveKarteData('middle');
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.textContent = 'æ¬¡ã¸ â†’';
      nextBtn.onclick = goNext;
      document.getElementById('backBtn').onclick = goBack;
      
      // è³ªå•ã‚’è¡¨ç¤º
      showQuestion();
    }
    
    async function saveKarteData(status) {
      try {
        karteData.status = status;
        karteData.estimatedPrice = calculatePrice();
        
        const response = await fetch(`https://naileonkarte-api.onrender.com/api/karte`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(karteData)
        });
        
        console.log('ä¿å­˜æˆåŠŸ:', status);
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    async function submitKarte() {
      document.getElementById('questionCard').innerHTML = `
        <div class="completion-screen">
          <div class="completion-icon">âœ¨</div>
          <div class="completion-title">ã‚«ãƒ«ãƒ†ç™»éŒ²å®Œäº†!</div>
          <div class="completion-text">
            ã”å¸Œæœ›ã«åˆã†ãƒã‚¤ãƒªã‚¹ãƒˆã‚’<br>ãƒãƒƒãƒãƒ³ã‚°ä¸­ã§ã™...
          </div>
          <div class="completion-highlight" style="margin-top: 30px;">
            é€šå¸¸1-2æ™‚é–“ä»¥å†…ã«LINEã§ã”é€£çµ¡ã„ãŸã—ã¾ã™ ğŸ’…
          </div>
        </div>
      `;
      
      document.getElementById('footer').style.display = 'none';
      
      try {
        karteData.status = 'full';
        karteData.estimatedPrice = calculatePrice();
        
        const response = await fetch(`https://naileonkarte-api.onrender.com/api/karte/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(karteData)
        });
        
        if (response.ok) {
          setTimeout(() => {
            window.location.href = `mypage.html?userId=${userId}`;
          }, 2000);
        }
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
  </script>
</body>
</html>
