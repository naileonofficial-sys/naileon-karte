<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ«ãƒ†å…¥åŠ› - ãƒã‚¤ãƒ¬ã‚ªãƒ³</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: linear-gradient(135deg, #ffeef8 0%, #fff5f7 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 10px;
      margin-bottom: 30px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #c44569);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255,107,157,0.5);
    }
    .progress-text {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 8px;
      font-weight: 500;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      margin-bottom: 20px;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .question-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 24px;
      color: #333;
      line-height: 1.5;
    }
    .option-btn {
      display: block;
      width: 100%;
      padding: 18px 20px;
      margin-bottom: 12px;
      background: #f8f9fa;
      border: 2px solid #f8f9fa;
      border-radius: 14px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      font-weight: 500;
      color: #333;
    }
    .option-btn:hover {
      background: #fff;
      border-color: #ffb3d1;
      transform: translateX(4px);
    }
    .option-btn.selected {
      background: #fff;
      border-color: #ff6b9d;
      color: #ff6b9d;
      font-weight: 600;
    }
    .input-field {
      width: 100%;
      padding: 18px;
      border: 2px solid #e9ecef;
      border-radius: 14px;
      font-size: 16px;
      transition: all 0.3s;
      font-family: inherit;
    }
    .input-field:focus {
      outline: none;
      border-color: #ff6b9d;
      box-shadow: 0 0 0 4px rgba(255,107,157,0.1);
    }
    .nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }
    .btn-back {
      background: #f8f9fa;
      color: #666;
    }
    .btn-back:hover {
      background: #e9ecef;
    }
    .btn-next {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
      box-shadow: 0 4px 12px rgba(255,107,157,0.3);
    }
    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,107,157,0.4);
    }
    .btn-next:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      box-shadow: none;
    }
    .completion-screen {
      text-align: center;
      padding: 60px 20px;
    }
    .completion-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: bounce 1s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .completion-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
    }
    .completion-text {
      color: #666;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    .completion-highlight {
      color: #ff6b9d;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>
    <div class="progress-text" id="progressText"></div>

    <div class="card" id="questionCard">
      <div class="question-title" id="questionTitle"></div>
      <div id="questionContent"></div>
      
      <div class="nav-buttons">
        <button class="btn btn-back" id="backBtn" onclick="goBack()">â† æˆ»ã‚‹</button>
        <button class="btn btn-next" id="nextBtn" onclick="goNext()">æ¬¡ã¸ â†’</button>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId') || 'test_user';
    const isEditMode = urlParams.get('edit') === 'true';
    
    let karteData = {
      userId: userId,
      timestamp: new Date().toISOString()
    };
    
    const questions = [
      {
        id: 'scene',
        title: 'ã©ã“ã§æ–½è¡“ã‚’å—ã‘ã¾ã™ã‹?',
        type: 'select',
        options: [
          { value: 'home', label: 'ğŸ  è‡ªå®…ãƒ»ãƒãƒ³ã‚·ãƒ§ãƒ³' },
          { value: 'hospital', label: 'ğŸ¥ ç—…é™¢ãƒ»ã‚¯ãƒªãƒ‹ãƒƒã‚¯' },
          { value: 'postnatal', label: 'ğŸ‘¶ ç”£å¾Œã‚±ã‚¢æ–½è¨­' },
          { value: 'care', label: 'ğŸ¢ ä»‹è­·ãƒ»ç¦ç¥‰æ–½è¨­' }
        ]
      },
      {
        id: 'hospitalName',
        title: 'æ–½è¨­åã‚’æ•™ãˆã¦ãã ã•ã„',
        type: 'text',
        placeholder: 'ä¾‹: â—‹â—‹ç·åˆç—…é™¢',
        condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
      },
      {
        id: 'permission',
        title: 'æ–½è¨­ã¸ã®è¨±å¯ã¯å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã‹?',
        type: 'select',
        options: [
          { value: 'obtained', label: 'âœ… å–å¾—æ¸ˆã¿' },
          { value: 'pending', label: 'â³ ç¢ºèªä¸­' },
          { value: 'not_yet', label: 'âŒ ã¾ã ã§ã™' }
        ],
        condition: (data) => ['hospital', 'postnatal', 'care'].includes(data.scene)
      },
      {
        id: 'prefecture',
        title: 'ã©ã¡ã‚‰ã®éƒ½é“åºœçœŒã§ã™ã‹?',
        type: 'select',
        options: [
          { value: 'åŒ—æµ·é“', label: 'åŒ—æµ·é“' },
          { value: 'é’æ£®çœŒ', label: 'é’æ£®çœŒ' },
          { value: 'å²©æ‰‹çœŒ', label: 'å²©æ‰‹çœŒ' },
          { value: 'å®®åŸçœŒ', label: 'å®®åŸçœŒ' },
          { value: 'ç§‹ç”°çœŒ', label: 'ç§‹ç”°çœŒ' },
          { value: 'å±±å½¢çœŒ', label: 'å±±å½¢çœŒ' },
          { value: 'ç¦å³¶çœŒ', label: 'ç¦å³¶çœŒ' },
          { value: 'èŒ¨åŸçœŒ', label: 'èŒ¨åŸçœŒ' },
          { value: 'æ ƒæœ¨çœŒ', label: 'æ ƒæœ¨çœŒ' },
          { value: 'ç¾¤é¦¬çœŒ', label: 'ç¾¤é¦¬çœŒ' },
          { value: 'åŸ¼ç‰çœŒ', label: 'åŸ¼ç‰çœŒ' },
          { value: 'åƒè‘‰çœŒ', label: 'åƒè‘‰çœŒ' },
          { value: 'æ±äº¬éƒ½', label: 'æ±äº¬éƒ½' },
          { value: 'ç¥å¥ˆå·çœŒ', label: 'ç¥å¥ˆå·çœŒ' },
          { value: 'æ–°æ½ŸçœŒ', label: 'æ–°æ½ŸçœŒ' },
          { value: 'å¯Œå±±çœŒ', label: 'å¯Œå±±çœŒ' },
          { value: 'çŸ³å·çœŒ', label: 'çŸ³å·çœŒ' },
          { value: 'ç¦äº•çœŒ', label: 'ç¦äº•çœŒ' },
          { value: 'å±±æ¢¨çœŒ', label: 'å±±æ¢¨çœŒ' },
          { value: 'é•·é‡çœŒ', label: 'é•·é‡çœŒ' },
          { value: 'å²é˜œçœŒ', label: 'å²é˜œçœŒ' },
          { value: 'é™å²¡çœŒ', label: 'é™å²¡çœŒ' },
          { value: 'æ„›çŸ¥çœŒ', label: 'æ„›çŸ¥çœŒ' },
          { value: 'ä¸‰é‡çœŒ', label: 'ä¸‰é‡çœŒ' },
          { value: 'æ»‹è³€çœŒ', label: 'æ»‹è³€çœŒ' },
          { value: 'äº¬éƒ½åºœ', label: 'äº¬éƒ½åºœ' },
          { value: 'å¤§é˜ªåºœ', label: 'å¤§é˜ªåºœ' },
          { value: 'å…µåº«çœŒ', label: 'å…µåº«çœŒ' },
          { value: 'å¥ˆè‰¯çœŒ', label: 'å¥ˆè‰¯çœŒ' },
          { value: 'å’Œæ­Œå±±çœŒ', label: 'å’Œæ­Œå±±çœŒ' },
          { value: 'é³¥å–çœŒ', label: 'é³¥å–çœŒ' },
          { value: 'å³¶æ ¹çœŒ', label: 'å³¶æ ¹çœŒ' },
          { value: 'å²¡å±±çœŒ', label: 'å²¡å±±çœŒ' },
          { value: 'åºƒå³¶çœŒ', label: 'åºƒå³¶çœŒ' },
          { value: 'å±±å£çœŒ', label: 'å±±å£çœŒ' },
          { value: 'å¾³å³¶çœŒ', label: 'å¾³å³¶çœŒ' },
          { value: 'é¦™å·çœŒ', label: 'é¦™å·çœŒ' },
          { value: 'æ„›åª›çœŒ', label: 'æ„›åª›çœŒ' },
          { value: 'é«˜çŸ¥çœŒ', label: 'é«˜çŸ¥çœŒ' },
          { value: 'ç¦å²¡çœŒ', label: 'ç¦å²¡çœŒ' },
          { value: 'ä½è³€çœŒ', label: 'ä½è³€çœŒ' },
          { value: 'é•·å´çœŒ', label: 'é•·å´çœŒ' },
          { value: 'ç†Šæœ¬çœŒ', label: 'ç†Šæœ¬çœŒ' },
          { value: 'å¤§åˆ†çœŒ', label: 'å¤§åˆ†çœŒ' },
          { value: 'å®®å´çœŒ', label: 'å®®å´çœŒ' },
          { value: 'é¹¿å…å³¶çœŒ', label: 'é¹¿å…å³¶çœŒ' },
          { value: 'æ²–ç¸„çœŒ', label: 'æ²–ç¸„çœŒ' }
        ]
      },
      {
        id: 'name',
        title: 'ãŠåå‰(ã‚«ãƒŠ)ã‚’æ•™ãˆã¦ãã ã•ã„',
        type: 'text',
        placeholder: 'ä¾‹: ãƒ¤ãƒãƒ€ãƒãƒŠã‚³'
      },
      {
        id: 'phone',
        title: 'å½“æ—¥ã®é€£çµ¡å…ˆé›»è©±ç•ªå·',
        type: 'tel',
        placeholder: 'ä¾‹: 09012345678'
      }
    ];
    
    let currentStep = 0;
    let visibleQuestions = [];
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    if (isEditMode) {
      loadExistingData();
    } else {
      showQuestion();
    }
    
    async function loadExistingData() {
      try {
        const response = await fetch(`https://naileonkarte-api.onrender.com/api/karte/${userId}`);
        if (response.ok) {
          const data = await response.json();
          karteData = data;
        }
      } catch (error) {
        console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰');
      }
      showQuestion();
    }
    
    function updateVisibleQuestions() {
      visibleQuestions = questions.filter(q => {
        if (q.condition) return q.condition(karteData);
        return true;
      });
    }
    
    function showQuestion() {
      updateVisibleQuestions();
      
      if (currentStep >= visibleQuestions.length) {
        submitKarte();
        return;
      }
      
      const question = visibleQuestions[currentStep];
      const progress = ((currentStep + 1) / visibleQuestions.length) * 100;
      
      document.getElementById('progress').style.width = progress + '%';
      document.getElementById('progressText').textContent = 
        `è³ªå• ${currentStep + 1} / ${visibleQuestions.length}`;
      document.getElementById('questionTitle').textContent = question.title;
      document.getElementById('backBtn').style.display = currentStep === 0 ? 'none' : 'block';
      
      const content = document.getElementById('questionContent');
      content.innerHTML = '';
      
      if (question.type === 'select') {
        question.options.forEach(option => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = option.label;
          btn.onclick = () => selectOption(question.id, option.value);
          
          if (karteData[question.id] === option.value) {
            btn.classList.add('selected');
          }
          
          content.appendChild(btn);
        });
      } else {
        const input = document.createElement('input');
        input.className = 'input-field';
        input.type = question.type;
        input.placeholder = question.placeholder;
        input.value = karteData[question.id] || '';
        input.oninput = (e) => {
          karteData[question.id] = e.target.value;
          updateNextButton();
        };
        content.appendChild(input);
      }
      
      updateNextButton();
    }
    
    function selectOption(key, value) {
      karteData[key] = value;
      showQuestion();
      updateNextButton();
    }
    
    function updateNextButton() {
      const question = visibleQuestions[currentStep];
      const hasAnswer = karteData[question.id] && karteData[question.id].trim() !== '';
      document.getElementById('nextBtn').disabled = !hasAnswer;
    }
    
    function goBack() {
      if (currentStep > 0) {
        currentStep--;
        showQuestion();
      }
    }
    
    function goNext() {
      currentStep++;
      showQuestion();
    }
    
    async function submitKarte() {
      document.getElementById('questionCard').innerHTML = `
        <div class="completion-screen">
          <div class="completion-icon">âœ¨</div>
          <div class="completion-title">ã‚«ãƒ«ãƒ†ç™»éŒ²å®Œäº†!</div>
          <div class="completion-text">
            ã”å¸Œæœ›ã«åˆã†ãƒã‚¤ãƒªã‚¹ãƒˆã‚’<br>ãƒãƒƒãƒãƒ³ã‚°ä¸­ã§ã™...
          </div>
          <div class="completion-highlight">
            é€šå¸¸1-2æ™‚é–“ä»¥å†…ã«LINEã§ã”é€£çµ¡ã„ãŸã—ã¾ã™ ğŸ’…
          </div>
        </div>
      `;
      
      try {
        const method = isEditMode ? 'PUT' : 'POST';
        const endpoint = isEditMode ? `/api/karte/${userId}` : '/api/karte';
        
        const response = await fetch(`https://naileonkarte-api.onrender.com${endpoint}`, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(karteData)
        });
        
        if (response.ok) {
          setTimeout(() => {
            window.location.href = `mypage.html?userId=${userId}`;
          }, 2000);
        }
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
  </script>
</body>
</html>
